# ì§ˆë¬¸-ë‹µë³€ ë¬¸ì œ ì§„ë‹¨ ê²°ê³¼

## ğŸ”´ ë¬¸ì œ ë°œê²¬!

### í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤
```
ì§ˆë¬¸: "2024ë…„ ë¬¸ì„œ ì°¾ì•„ì¤˜"
```

### ì‹¤í–‰ ê²°ê³¼
```
ğŸ“‹ ëª©ë¡ ê²€ìƒ‰: year=2024, drafter=ë¬¸ì„œ, limit=20
ì‘ë‹µ: ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. (year=2024, drafter=ë¬¸ì„œ)
```

## ğŸ¯ ë¬¸ì œ ì›ì¸

### 1. ì˜ëª»ëœ íŒŒì‹±
**íŒŒì¼**: `app/rag/pipeline.py` â†’ `_answer_list()` ë©”ì†Œë“œ

ì¿¼ë¦¬ íŒŒì‹± ë¡œì§ì´ "ë¬¸ì„œ"ë¥¼ **ê¸°ì•ˆì(drafter)**ë¡œ ì˜ëª» ì¸ì‹:
- ì…ë ¥: "2024ë…„ ë¬¸ì„œ ì°¾ì•„ì¤˜"
- íŒŒì‹± ê²°ê³¼:
  - year=2024 âœ… (ì •ìƒ)
  - drafter=**ë¬¸ì„œ** âŒ (ì˜¤ë¥˜!)

### 2. ê²€ìƒ‰ ì‹¤íŒ¨
```python
# ì‹¤ì œ ì‹¤í–‰ëœ ì¿¼ë¦¬
db.search_documents(year=2024, drafter="ë¬¸ì„œ", limit=20)
# â†’ ê²°ê³¼: 0ê°œ (ë‹¹ì—°íˆ "ë¬¸ì„œ"ë¼ëŠ” ì´ë¦„ì˜ ê¸°ì•ˆìëŠ” ì—†ìŒ)
```

### 3. ê¸°ëŒ€ ë™ì‘
```python
# ì˜¬ë°”ë¥¸ ì¿¼ë¦¬
db.search_documents(year=2024, drafter=None, limit=20)
# â†’ ê²°ê³¼: 2024ë…„ì˜ ëª¨ë“  ë¬¸ì„œ
```

## ğŸ” ì½”ë“œ ë¶„ì„

### ë¬¸ì œ ì½”ë“œ ìœ„ì¹˜
`app/rag/pipeline.py` - `_answer_list()` ë©”ì†Œë“œ

```python
def _answer_list(self, query: str) -> dict:
    # ì¿¼ë¦¬ íŒŒì‹±
    # âš ï¸ ë¬¸ì œ: "ë¬¸ì„œ", "ìë£Œ" ê°™ì€ ì¼ë°˜ ëª…ì‚¬ë¥¼ ê¸°ì•ˆìë¡œ ì¸ì‹
    drafter = self._parse_drafter(query)  # â† ì—¬ê¸°ì„œ "ë¬¸ì„œ" ì¶”ì¶œ
    year = self._parse_year(query)
```

### íŒŒì‹± ë¡œì§ì˜ ë¬¸ì œì 
"ë¬¸ì„œ", "ìë£Œ", "íŒŒì¼" ê°™ì€ ì¼ë°˜ í‚¤ì›Œë“œë¥¼ ê¸°ì•ˆì ì´ë¦„ìœ¼ë¡œ ì˜ëª» ì¸ì‹í•  ê°€ëŠ¥ì„±:
- "2024ë…„ ë¬¸ì„œ ì°¾ì•„ì¤˜" â†’ drafter="ë¬¸ì„œ"
- "ê¹€ì² ìˆ˜ ìë£Œ ì°¾ì•„ì¤˜" â†’ drafter="ìë£Œ"? or "ê¹€ì² ìˆ˜"?
- "ë³´ê³ ì„œ ê²€ìƒ‰í•´ì¤˜" â†’ drafter="ë³´ê³ ì„œ"?

## ğŸ’¡ í•´ê²° ë°©ì•ˆ

### ë°©ì•ˆ 1: ë¶ˆìš©ì–´ í•„í„°ë§ (ì¶”ì²œ)
ì¼ë°˜ ëª…ì‚¬ë¥¼ ê¸°ì•ˆìì—ì„œ ì œì™¸:

```python
# ê¸°ì•ˆìë¡œ ì¸ì‹í•˜ì§€ ë§ì•„ì•¼ í•  ë‹¨ì–´ë“¤
STOPWORDS = {
    "ë¬¸ì„œ", "ìë£Œ", "íŒŒì¼", "ë³´ê³ ì„œ", "ë°ì´í„°",
    "ë¦¬ìŠ¤íŠ¸", "ëª©ë¡", "ê²€ìƒ‰", "ì°¾ê¸°", "ì¡°íšŒ"
}

def _parse_drafter(self, query: str) -> Optional[str]:
    # ... ê¸°ì¡´ ë¡œì§ ...
    if drafter in STOPWORDS:
        return None
    return drafter
```

### ë°©ì•ˆ 2: íŒ¨í„´ ìš°ì„ ìˆœìœ„ ì¡°ì •
ëª…ì‹œì  íŒ¨í„´ë§Œ ì¸ì‹:
```python
# ëª…í™•í•œ íŒ¨í„´ë§Œ ì¸ì‹
DRAFTER_PATTERNS = [
    r"(.+?)ê°€\s*ì‘ì„±",  # "ê¹€ì² ìˆ˜ê°€ ì‘ì„±"
    r"(.+?)ë‹˜\s*ë¬¸ì„œ",  # "ê¹€ì² ìˆ˜ë‹˜ ë¬¸ì„œ"
    r"ì‘ì„±ì[:\s]+(.+)",  # "ì‘ì„±ì: ê¹€ì² ìˆ˜"
]
```

### ë°©ì•ˆ 3: ë©”íƒ€ë°ì´í„° ê²€ì¦
íŒŒì‹±ëœ ê¸°ì•ˆìê°€ ì‹¤ì œ DBì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸:

```python
def _parse_drafter(self, query: str) -> Optional[str]:
    drafter = self._extract_drafter(query)

    # DBì— ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ê¸°ì•ˆìì¸ì§€ í™•ì¸
    if drafter:
        exists = self.metadata_db.drafter_exists(drafter)
        if not exists:
            logger.warning(f"ê¸°ì•ˆì '{drafter}'ê°€ DBì— ì—†ìŒ - ë¬´ì‹œ")
            return None

    return drafter
```

## ğŸ”§ ì¦‰ì‹œ ìˆ˜ì • í•„ìš” ì‚¬í•­

### 1. _parse_drafter í•¨ìˆ˜ ìˆ˜ì •
**ìœ„ì¹˜**: `app/rag/pipeline.py`

í˜„ì¬ ë¡œì§ì„ ë³´ê³  ë¶ˆìš©ì–´ í•„í„° ì¶”ê°€

### 2. í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì¶”ê°€
```python
# í…ŒìŠ¤íŠ¸í•´ì•¼ í•  ì¿¼ë¦¬ë“¤
test_queries = [
    ("2024ë…„ ë¬¸ì„œ ì°¾ì•„ì¤˜", {"year": 2024, "drafter": None}),
    ("ê¹€ì² ìˆ˜ê°€ ì‘ì„±í•œ ë¬¸ì„œ", {"year": None, "drafter": "ê¹€ì² ìˆ˜"}),
    ("2023ë…„ ë³´ê³ ì„œ ê²€ìƒ‰", {"year": 2023, "drafter": None}),
]
```

### 3. ë¡œê¹… ê°œì„ 
íŒŒì‹± ê²°ê³¼ë¥¼ ëª…í™•íˆ ë¡œê¹…:
```python
logger.info(f"ğŸ“‹ íŒŒì‹± ê²°ê³¼: year={year}, drafter={drafter} (ì¿¼ë¦¬: '{query}')")
```

## ğŸ“Š ì˜í–¥ ë²”ìœ„

### ì˜í–¥ ë°›ëŠ” ê¸°ëŠ¥
- LIST ëª¨ë“œ (ëª©ë¡ ê²€ìƒ‰)
- ì—°ë„ë³„ ë¬¸ì„œ ê²€ìƒ‰
- ê¸°ì•ˆìë³„ ë¬¸ì„œ ê²€ìƒ‰

### ì •ìƒ ì‘ë™í•˜ëŠ” ê¸°ëŠ¥
- COST_SUM ëª¨ë“œ (ë¹„ìš© í•©ê³„)
- SUMMARY ëª¨ë“œ (ìš”ì•½)
- PREVIEW ëª¨ë“œ (ë¯¸ë¦¬ë³´ê¸°)
- QA ëª¨ë“œ (ì¼ë°˜ ì§ˆì˜ì‘ë‹µ)

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

1. **ì¦‰ì‹œ ìˆ˜ì •**: `_parse_drafter()` í•¨ìˆ˜ì— ë¶ˆìš©ì–´ í•„í„° ì¶”ê°€
2. **í…ŒìŠ¤íŠ¸**: ë‹¤ì–‘í•œ ì¿¼ë¦¬ íŒ¨í„´ìœ¼ë¡œ ê²€ì¦
3. **ëª¨ë‹ˆí„°ë§**: ì‹¤ì œ ì‚¬ìš©ì ì¿¼ë¦¬ì—ì„œ íŒŒì‹± ì˜¤ë¥˜ ì¶”ì 

## ê²€ì¦ ëª…ë ¹ì–´

```bash
# ë¼ìš°íŒ… í…ŒìŠ¤íŠ¸
python diagnose_qa_flow.py "2024ë…„ ë¬¸ì„œ ì°¾ì•„ì¤˜" --route-only

# ì „ì²´ í…ŒìŠ¤íŠ¸
python diagnose_qa_flow.py "2024ë…„ ë¬¸ì„œ ì°¾ì•„ì¤˜"

# ë‹¤ì–‘í•œ íŒ¨í„´ í…ŒìŠ¤íŠ¸
python diagnose_qa_flow.py "ê¹€ì² ìˆ˜ ë¬¸ì„œ"
python diagnose_qa_flow.py "2023ë…„ ë³´ê³ ì„œ"
python diagnose_qa_flow.py "ë°•ì˜í¬ê°€ ì‘ì„±í•œ ìë£Œ"
```