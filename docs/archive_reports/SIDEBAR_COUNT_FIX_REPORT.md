# 사이드탭 카운트 정합성 수정 보고서

## 문제 상황
사이드바에 표시되는 3개 지표가 서로 다른 소스를 참조하여 불일치 발생:
- **자동 인덱싱**: PDF 490 + TXT 3 = 493 (물리 파일 수)
- **문서 라이브러리 총 문서**: 479건 (잘못된 값)
- **검색 가능**: 483개 문서 (정답)

정답: **고유 문서 483개 (PDF 480 + TXT 3)**

## 원인 분석

### 1. 다중 데이터 소스 문제
- 각 지표가 다른 소스 사용:
  - 자동 인덱싱: file_index.json (물리 파일)
  - 총 문서: metadata.db 직접 쿼리 (479개만 있었음)
  - 검색 가능: DataFrame nunique()

### 2. 데이터베이스 불일치
- **metadata.db**: 479개 (4개 누락)
- **everything_index.db**: 483개 (정상)
- **누락 파일**:
  - AS_IS_TREE.txt
  - IMPORT_GRAPH.txt
  - ENTRYPOINT_HITS.txt
  - 2024-10-24_2024_채널에이_중계차_노후_보수건.pdf

## 수정 내용

### 1. 통합 카운트 API 구현
**파일**: `modules/metadata_db.py`

새로운 메서드 추가:
- `count_unique_documents()`: 고유 문서 수 (중복 제거, 확장자 필터)
- `count_by_extension()`: 확장자별 물리 파일 수
- `count_search_index()`: 검색 인덱스 등록 문서 수

### 2. 중앙 설정 관리
**파일**: `config/indexing.py`

```python
ALLOWED_EXTS = {".pdf", ".txt"}  # 허용 확장자 중앙 관리
```

### 3. 사이드바 UI 개선
**파일**: `components/sidebar_library.py`

변경 사항:
- "자동 인덱싱" → "📁 파일 스캔 (물리)" 명확화
- 모든 카운트를 통합 API 사용으로 단일화
- 카운트 불일치 시 경고 배지 표시
- 원클릭 재색인 버튼 추가

### 4. 누락 데이터 복구
**스크립트**: `fix_metadata_db.py`

- metadata.db에 누락된 4개 파일 추가
- 479 → 483개로 정상화

## 검증 결과

### 테스트 실행 결과
```bash
$ python tests/test_sidebar_counts.py

=== 케이스1: PDF + TXT 카운트 검증 ===
라이브러리 총 문서 (PDF+TXT): 483개 ✅
물리 파일 - PDF: 480개, TXT: 3개
검색 인덱스: 483개 ✅

=== 통합 카운트 일관성 테스트 ===
✅ library_vs_search: True
✅ library_expected: True
✅ physical_expected: True

✅ 모든 테스트 통과!
```

### 최종 상태
| 지표 | 이전 (불일치) | 현재 (정상) |
|------|-------------|------------|
| 파일 스캔 (물리) | 493 | 493 (PDF 490 + TXT 3) |
| 문서 라이브러리 총 문서 | **479** ❌ | **483** ✅ |
| 검색 가능 | 483 | 483 ✅ |

## 생성/수정 파일

| 파일 | 변경 내용 |
|------|----------|
| `modules/metadata_db.py` | 통합 카운트 API 함수 3개 추가 |
| `config/indexing.py` | 새 파일 - 허용 확장자 중앙 관리 |
| `config/__init__.py` | 새 파일 - 패키지 초기화 |
| `components/sidebar_library.py` | 카운트 로직 단일화, 경고 배지 추가 |
| `tests/test_sidebar_counts.py` | 새 파일 - 정합성 테스트 |
| `fix_metadata_db.py` | 새 파일 - 누락 데이터 복구 스크립트 |
| `utils/year_utils.py` | 새 파일 - year 필드 타입 처리 유틸리티 |

## 개선 효과

### 1. 데이터 정합성
- ✅ 모든 지표가 단일 소스(metadata.db) 기반
- ✅ 중복 제거 및 확장자 필터 일관성
- ✅ 483개 고유 문서로 통일

### 2. 유지보수성
- ✅ 중앙 설정으로 정책 변경 용이
- ✅ 통합 API로 카운트 로직 단순화
- ✅ 테스트로 지속적 검증 가능

### 3. 사용자 경험
- ✅ 명확한 라벨링 (물리/라이브러리/검색)
- ✅ 불일치 시 시각적 경고
- ✅ 원클릭 재색인으로 문제 해결

## 권장사항

1. **정기 동기화**: 주기적으로 DB 간 동기화 체크
2. **자동 검증**: CI/CD에 카운트 정합성 테스트 포함
3. **TXT 정책 결정**: ALLOWED_EXTS 설정으로 TXT 포함/제외 확정

## 결론

사이드탭 카운트 불일치 문제가 완전히 해결되었습니다.
- **이전**: 479 / 483 / 493 (불일치)
- **현재**: 483 / 483 / 493 (정상)

모든 지표가 정확한 고유 문서 수 **483개**를 표시하며, 물리 파일 수는 별도로 명확히 구분하여 표시됩니다.