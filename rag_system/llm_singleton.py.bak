"""
LLM Singleton Manager
LLM ì¸ìŠ¤í„´ìŠ¤ë¥¼ ì¬ì‚¬ìš©í•˜ì—¬ ì´ˆê¸°í™” ì‹œê°„ ë‹¨ì¶•
"""

import threading
from typing import Optional
from pathlib import Path
import logging
from .qwen_llm import QwenLLM, GenerationConfig

class LLMSingleton:
    """LLM ì‹±ê¸€í†¤ ê´€ë¦¬ì"""
    
    _instance: Optional[QwenLLM] = None
    _lock = threading.Lock()
    _logger = logging.getLogger(__name__)
    
    @classmethod
    def get_instance(cls, model_path: str = None, config: GenerationConfig = None) -> QwenLLM:
        """LLM ì¸ìŠ¤í„´ìŠ¤ ë°˜í™˜ (ì—†ìœ¼ë©´ ìƒì„±)
        
        Args:
            model_path: ëª¨ë¸ ê²½ë¡œ (ì²« ìƒì„±ì‹œ í•„ìˆ˜)
            config: ìƒì„± ì„¤ì • (ì„ íƒ)
            
        Returns:
            QwenLLM ì¸ìŠ¤í„´ìŠ¤
        """
        if cls._instance is None:
            with cls._lock:
                # ë”ë¸”ì²´í¬ ë½í‚¹
                if cls._instance is None:
                    if model_path is None:
                        raise ValueError("ì²« ì¸ìŠ¤í„´ìŠ¤ ìƒì„±ì‹œ model_pathê°€ í•„ìš”í•©ë‹ˆë‹¤")
                    
                    cls._logger.info("ğŸš€ LLM ì¸ìŠ¤í„´ìŠ¤ ìµœì´ˆ ìƒì„± ì¤‘...")
                    import time
                    start = time.time()
                    
                    cls._instance = QwenLLM(model_path=model_path, config=config)
                    
                    elapsed = time.time() - start
                    cls._logger.info(f"âœ… LLM ì¸ìŠ¤í„´ìŠ¤ ìƒì„± ì™„ë£Œ ({elapsed:.1f}ì´ˆ)")
        
        return cls._instance
    
    @classmethod
    def clear_instance(cls):
        """ì¸ìŠ¤í„´ìŠ¤ ì´ˆê¸°í™” (ë©”ëª¨ë¦¬ í•´ì œ)"""
        with cls._lock:
            if cls._instance is not None:
                cls._logger.info("ğŸ§¹ LLM ì¸ìŠ¤í„´ìŠ¤ í•´ì œ")
                cls._instance = None
    
    @classmethod
    def is_loaded(cls) -> bool:
        """ì¸ìŠ¤í„´ìŠ¤ ë¡œë“œ ì—¬ë¶€ í™•ì¸"""
        return cls._instance is not None